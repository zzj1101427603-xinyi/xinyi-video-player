name: Build Android APK

on:
  workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          npm install -g expo-cli eas-cli
          npm install

      - name: Create and verify icon files
        run: |
          echo "创建图标文件..."
          mkdir -p assets
          
          # 创建一个简单的1x1像素的PNG图片（蓝色）
          echo -n -e '\x89PNG\r\n\x1a\n\x00\x00\x00\rIHDR\x00\x00\x00\x01\x00\x00\x00\x01\x08\x06\x00\x00\x00\x1f\x15\xc4\x89\x00\x00\x00\rIDATx\x9cc\xf8\x0f\x00\x00\x01\x01\x00\x05\x00\x1d\xa3\xd4\x55\x00\x00\x00\x00IEND\xaeB\x60\x82' > assets/icon.png
          
          # 复制相同的内容到 adaptive-icon.png
          cp assets/icon.png assets/adaptive-icon.png
          
          echo "验证文件是否创建成功:"
          ls -la assets/
          echo "文件大小:"
          du -h assets/*.png

      - name: Prebuild Android
        run: |
          expo prebuild --platform android --non-interactive

      - name: Build Android APK
        run: |
          cd android
          ./gradlew assembleRelease

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: android/app/build/outputs/apk/release/app-release.apk
