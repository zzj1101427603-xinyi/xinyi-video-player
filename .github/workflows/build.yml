name: Build Android APK - 最终稳定版

on:
  workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: 1. 检出代码
        uses: actions/checkout@v4
        
      - name: 2. 设置Node.js环境
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: 3. 验证和修复图标文件
        run: |
          echo "验证图标文件..."
          # 确保图标文件存在且有效
          if [ -f "assets/icon.png" ]; then
            echo "✓ 发现图标文件"
            # 使用imagemagick确保PNG格式正确
            if command -v convert &> /dev/null; then
              convert assets/icon.png -resize 1024x1024 assets/icon-fixed.png
              mv assets/icon-fixed.png assets/icon.png
            fi
          else
            echo "✗ 未找到图标文件，创建默认图标"
            mkdir -p assets
            # 创建纯蓝色1024x1024图标
            convert -size 1024x1024 xc:#2196F3 assets/icon.png
          fi
          
          # 创建简单的自适应图标
          cp assets/icon.png assets/adaptive-icon.png
          
      - name: 4. 安装依赖
        run: |
          echo "安装项目依赖..."
          npm ci
          
      - name: 5. 使用简化构建流程
        run: |
          echo "开始简化构建流程..."
          
          # 创建最简化的Android项目结构
          mkdir -p android/app/src/main/res
          
          # 创建必要的资源文件
          mkdir -p android/app/src/main/res/drawable
          cp assets/icon.png android/app/src/main/res/drawable/ic_launcher.png
          
          # 创建AndroidManifest.xml
          cat > android/app/src/main/AndroidManifest.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android"
              package="com.xinyi.videoplayer">
              
              <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
              <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
              <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />
              <uses-permission android:name="android.permission.WAKE_LOCK" />
              
              <application
                  android:name=".MainApplication"
                  android:label="馨逸超可爱"
                  android:icon="@drawable/ic_launcher"
                  android:allowBackup="true"
                  android:theme="@style/AppTheme"
                  android:usesCleartextTraffic="true">
                  
                  <activity
                      android:name=".MainActivity"
                      android:label="馨逸超可爱"
                      android:configChanges="keyboard|keyboardHidden|orientation|screenLayout|screenSize|smallestScreenSize|uiMode"
                      android:launchMode="singleTask"
                      android:windowSoftInputMode="adjustResize"
                      android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
                  
                  <service
                      android:name=".VideoPlaybackService"
                      android:enabled="true"
                      android:exported="false" />
                      
              </application>
          </manifest>
          EOF
          
          echo "项目结构创建完成"
          
      - name: 6. 创建Gradle构建文件
        run: |
          echo "配置Gradle构建..."
          
          # 创建项目级build.gradle
          cat > android/build.gradle << 'EOF'
          buildscript {
              ext {
                  buildToolsVersion = "33.0.0"
                  minSdkVersion = 21
                  compileSdkVersion = 33
                  targetSdkVersion = 33
                  kotlinVersion = "1.8.0"
              }
              repositories {
                  google()
                  mavenCentral()
              }
              dependencies {
                  classpath("com.android.tools.build:gradle:7.3.1")
                  classpath("org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlinVersion")
              }
          }
          
          allprojects {
              repositories {
                  maven {
                      url("$rootDir/../node_modules/react-native/android")
                  }
                  maven {
                      url("$rootDir/../node_modules/expo-camera/android/maven")
                  }
                  google()
                  mavenCentral()
                  maven { url 'https://www.jitpack.io' }
              }
          }
          EOF
          
          # 创建应用级build.gradle
          cat > android/app/build.gradle << 'EOF'
          apply plugin: "com.android.application"
          apply plugin: "kotlin-android"
          
          android {
              compileSdkVersion rootProject.ext.compileSdkVersion
              
              defaultConfig {
                  applicationId "com.xinyi.videoplayer"
                  minSdkVersion rootProject.ext.minSdkVersion
                  targetSdkVersion rootProject.ext.targetSdkVersion
                  versionCode 1
                  versionName "1.0.0"
              }
              
              signingConfigs {
                  debug {
                      storeFile file('debug.keystore')
                      storePassword 'android'
                      keyAlias 'androiddebugkey'
                      keyPassword 'android'
                  }
              }
              
              buildTypes {
                  debug {
                      signingConfig signingConfigs.debug
                  }
                  release {
                      signingConfig signingConfigs.debug
                      minifyEnabled false
                      proguardFiles getDefaultProguardFile("proguard-android.txt"), "proguard-rules.pro"
                  }
              }
          }
          
          dependencies {
              implementation fileTree(dir: "libs", include: ["*.jar"])
              implementation "org.jetbrains.kotlin:kotlin-stdlib:$kotlinVersion"
              implementation "androidx.appcompat:appcompat:1.6.1"
              implementation "com.facebook.react:react-android:0.72.6"
          }
          EOF
          
          # 创建debug.keystore
          cd android/app
          keytool -genkey -v -keystore debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US"
          
      - name: 7. 创建React Native入口文件
        run: |
          echo "创建React Native应用文件..."
          
          # 创建MainApplication.java
          mkdir -p android/app/src/main/java/com/xinyi/videoplayer
          
          cat > android/app/src/main/java/com/xinyi/videoplayer/MainApplication.java << 'EOF'
          package com.xinyi.videoplayer;
          
          import android.app.Application;
          import android.content.res.Configuration;
          
          import com.facebook.react.PackageList;
          import com.facebook.react.ReactApplication;
          import com.facebook.react.ReactNativeHost;
          import com.facebook.react.ReactPackage;
          import com.facebook.react.defaults.DefaultNewArchitectureEntryPoint;
          import com.facebook.react.defaults.DefaultReactNativeHost;
          import com.facebook.soloader.SoLoader;
          
          import java.util.List;
          
          public class MainApplication extends Application implements ReactApplication {
          
              private final ReactNativeHost mReactNativeHost =
                      new DefaultReactNativeHost(this) {
                          @Override
                          public boolean getUseDeveloperSupport() {
                              return BuildConfig.DEBUG;
                          }
          
                          @Override
                          protected List<ReactPackage> getPackages() {
                              @SuppressWarnings("UnnecessaryLocalVariable")
                              List<ReactPackage> packages = new PackageList(this).getPackages();
                              return packages;
                          }
          
                          @Override
                          protected String getJSMainModuleName() {
                              return "index";
                          }
          
                          @Override
                          protected boolean isNewArchEnabled() {
                              return BuildConfig.IS_NEW_ARCHITECTURE_ENABLED;
                          }
          
                          @Override
                          protected Boolean isHermesEnabled() {
                              return BuildConfig.IS_HERMES_ENABLED;
                          }
                      };
          
              @Override
              public ReactNativeHost getReactNativeHost() {
                  return mReactNativeHost;
              }
          
              @Override
              public void onCreate() {
                  super.onCreate();
                  SoLoader.init(this, false);
                  if (BuildConfig.IS_NEW_ARCHITECTURE_ENABLED) {
                      DefaultNewArchitectureEntryPoint.load();
                  }
              }
          
              @Override
              public void onConfigurationChanged(Configuration newConfig) {
                  super.onConfigurationChanged(newConfig);
              }
          }
          EOF
          
          # 创建MainActivity.java
          cat > android/app/src/main/java/com/xinyi/videoplayer/MainActivity.java << 'EOF'
          package com.xinyi.videoplayer;
          
          import com.facebook.react.ReactActivity;
          import com.facebook.react.ReactActivityDelegate;
          import com.facebook.react.defaults.DefaultNewArchitectureEntryPoint;
          import com.facebook.react.defaults.DefaultReactActivityDelegate;
          
          public class MainActivity extends ReactActivity {
          
              @Override
              protected String getMainComponentName() {
                  return "XinyiVideoPlayer";
              }
          
              @Override
              protected ReactActivityDelegate createReactActivityDelegate() {
                  return new DefaultReactActivityDelegate(
                          this,
                          getMainComponentName(),
                          DefaultNewArchitectureEntryPoint.getFabricEnabled()
                  );
              }
          }
          EOF
          
      - name: 8. 构建APK
        run: |
          echo "开始构建APK..."
          cd android
          chmod +x gradlew
          ./gradlew clean
          ./gradlew assembleRelease
          
          echo "构建完成！APK位置："
          find . -name "*.apk" -type f
          
      - name: 9. 上传APK文件
        uses: actions/upload-artifact@v4
        with:
          name: 馨逸超可爱-APK
          path: android/app/build/outputs/apk/release/*.apk
